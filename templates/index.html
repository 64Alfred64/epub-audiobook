<script>
  // keep your voice list and selector population
  const voices = [
    "en-AU-NatashaNeural", "en-AU-WilliamNeural", "en-CA-ClaraNeural", "en-CA-LiamNeural",
    "en-GB-LibbyNeural", "en-GB-RyanNeural", "en-GB-SoniaNeural", "en-IN-NeerjaNeural",
    "en-IN-PriyaNeural", "en-US-AriaNeural", "en-US-GuyNeural", "en-US-JennyNeural",
    "en-US-MichelleNeural", "en-US-TonyNeural"
  ];
  const voiceSelect = document.getElementById('voiceSelect');
  voices.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v; opt.textContent = v;
    voiceSelect.appendChild(opt);
  });

  const form        = document.getElementById('uploadForm');
  const statusDiv   = document.getElementById('status');
  const textDisplay = document.getElementById('textDisplay');
  let uploadId      = null;
  let currentAudio  = null;

  form.addEventListener('submit', async e => {
    e.preventDefault();
    statusDiv.textContent    = 'Extracting text…';
    textDisplay.innerHTML    = '';
    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }
    const fd = new FormData(form);

    // fast extract-text endpoint
    const res = await fetch('/upload', { method:'POST', body: fd });
    if (!res.ok) {
      statusDiv.textContent = `Error: ${await res.text()}`;
      return;
    }
    const { upload_id, text_chunks } = await res.json();
    uploadId     = upload_id;
    statusDiv.textContent = 'Ready! Click any sentence to play.';

    text_chunks.forEach((chunk, i) => {
      const span = document.createElement('span');
      span.textContent        = chunk + ' ';
      span.dataset.index      = i;
      span.dataset.audioUrl   = `/chunk`;
      textDisplay.appendChild(span);
    });
  });

  textDisplay.addEventListener('click', async e => {
    if (e.target.tagName !== 'SPAN') return;
    // highlight selection
    textDisplay.querySelectorAll('span').forEach(s => s.classList.remove('highlight'));
    e.target.classList.add('highlight');

    statusDiv.textContent = 'Generating audio…';
    const idx = e.target.dataset.index;

    const chunkRes = await fetch('/chunk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ upload_id: uploadId, index: idx })
    });
    if (!chunkRes.ok) {
      statusDiv.textContent = `Audio error: ${await chunkRes.text()}`;
      return;
    }

    const blob = await chunkRes.blob();
    statusDiv.textContent = 'Playing…';
    if (currentAudio) currentAudio.pause();
    currentAudio = new Audio(URL.createObjectURL(blob));
    currentAudio.play();
  });
</script>
