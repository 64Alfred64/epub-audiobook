<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EPUB Audio Reader</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #121212;
      color: #eee;
      margin: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar {
      width: 250px;
      background: #1f1f1f;
      padding: 1rem;
      transform: translateX(-250px);
      transition: transform 0.3s ease;
      overflow-y: auto;
      box-shadow: 2px 0 6px rgba(0,0,0,0.5);
      z-index: 1001;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      height: 100vh;
    }
    #sidebar.open {
      transform: translateX(0);
    }
    #sidebar h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.2rem;
      font-weight: 600;
    }
    #chapterList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #chapterList li {
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #chapterList li:hover {
      background: rgba(76,139,245,0.2);
    }
    #sidebar-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 2.5rem;
      height: 2.5rem;
      background: #4c8bf5;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 1.4rem;
      cursor: pointer;
      z-index: 1102;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
      transition: background 0.2s;
    }
    #sidebar-close:focus {
      outline: 2px solid #fff;
    }
    #hamburger {
      position: fixed;
      top: 1rem;
      left: 1rem;
      width: 2.5rem;
      height: 2.5rem;
      background: #4c8bf5;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 1.4rem;
      cursor: pointer;
      z-index: 1100;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
      transition: background 0.2s;
    }
    #hamburger:focus {
      outline: 2px solid #fff;
    }
    #hamburger.open {
      background: #3a6fe2;
    }
    #sidebar-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    #sidebar.open + #sidebar-overlay {
      display: block;
    }
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 2rem;
      overflow-y: auto;
      margin-left: 0;
      transition: margin 0.3s;
      width: 100vw;
      padding-bottom: 6.5rem;
    }
    #textDisplay {
      margin: 3em auto 0 auto;
      max-width: 700px;
      width: 100%;
      padding: 2em 1.5em 3em 1.5em;
      background: #181818;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.22);
      font-family: 'Georgia', 'Times New Roman', serif;
      font-size: 1.18em;
      line-height: 1.75;
      color: #ececec;
      letter-spacing: 0.01em;
      transition: all 0.2s;
    }
    #textDisplay h1, #textDisplay h2, #textDisplay h3 {
      font-family: 'Inter', 'Helvetica Neue', Arial, sans-serif;
      color: #f6f6f6;
      margin-top: 2.5em;
      margin-bottom: 1.5em;
      font-weight: 700;
      letter-spacing: 0.01em;
      text-align: center;
    }
    #textDisplay p {
      margin: 0 0 1.4em 0;
      text-align: justify;
      text-indent: 2em;
      font-size: 1.18em;
      line-height: 1.75;
    }
    #textDisplay p + h1, #textDisplay p + h2, #textDisplay p + h3 {
      margin-top: 2.5em;
    }
    .highlight {
      background: rgba(76,139,245,0.18);
      border-left: 4px solid #4c8bf5;
      padding-left: 0.5em;
    }
    @media (max-width: 700px) {
      #textDisplay {
        padding: 1em 0.5em 4.5em 0.5em;
        max-width: 100vw;
        border-radius: 0;
      }
      #main {
        padding-bottom: 7rem;
      }
      #chapterList li {
        font-size: 0.95rem;
        padding: 0.4rem 0.7rem;
        height: 2.2rem;
      }
    }
    @media (min-width: 700px) {
      #main {
        margin-left: 250px;
        width: calc(100vw - 250px);
        padding-bottom: 4.5rem;
      }
    }
    .eleven-player { display: none !important; }
    @media (max-width: 700px) {
      .sidebar {
        position: fixed !important;
        top: 0; left: 0;
        height: 100vh;
        width: 80vw;
        max-width: 320px;
        z-index: 1101;
        background: #000;
        border-right: 1px solid #333;
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(.4,0,.2,1);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar-overlay {
        display: block;
      }
      .main-content {
        padding-left: 0 !important;
      }
    }
    @media (min-width: 701px) {
      .sidebar {
        transform: none !important;
        position: static !important;
        width: 280px;
        min-width: 280px;
        max-width: 280px;
        height: 100vh;
        z-index: 1001;
        background: #000;
        border-right: 1px solid #333;
      }
      .sidebar-overlay {
        display: none !important;
      }
      .main-content {
        padding-left: 280px !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-container h-screen w-screen grid grid-cols-[auto_1fr] grid-rows-[1fr_auto]">
    <button class="hamburger block md:hidden fixed top-4 left-4 z-[1100] bg-[#222] text-white p-2 rounded focus:outline-none" aria-label="Open sidebar" id="hamburgerBtn">☰</button>
    <div class="sidebar-overlay fixed inset-0 bg-black/60 z-[1099] hidden" id="sidebarOverlay"></div>
    <div class="sidebar row-span-2 h-full w-[280px] bg-black border-r border-[#333] overflow-y-auto p-5 z-[1101] transition-transform duration-300 -translate-x-full md:translate-x-0 fixed md:static top-0 left-0" id="sidebar">
      <div class="sidebar-header flex items-center gap-2 mb-4">
        <button class="back-button control-btn">&lt;</button>
        <img id="sidebarCover" src="" alt="Book cover" style="width:56px;height:80px;object-fit:cover;border-radius:6px;background:#222;display:none;margin-right:0.75em;"/>
        <h2 class="book-title flex-1 text-lg font-bold text-white" id="sidebarBookTitle">Book Title</h2>
        <button class="menu-button control-btn">⋯</button>
      </div>
      <div class="chapter-list">
        <h3 class="text-xs font-semibold text-gray-500 mb-2">Chapters</h3>
        <ul class="chapter-nav" id="chapterList"></ul>
      </div>
    </div>
    <div style="position:fixed;top:0;left:0;width:100vw;z-index:2147483647;background:#181818;border-bottom:1px solid #333;box-shadow:0 4px 24px 0 rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;min-height:48px;padding:0 16px;">
      <h1 style="font-size:1.1rem;font-weight:600;color:#fff;margin:0 16px 0 0;white-space:nowrap;">EPUB Audio Reader</h1>
      <form id="uploadForm" enctype="multipart/form-data" style="display:flex;flex-direction:row;align-items:center;gap:8px;">
        <input type="file" name="file" accept=".epub" required style="font-size:0.95rem;color:#ccc;background:#23232a;border:1px solid #444;border-radius:4px;padding:4px 8px;"/>
        <select id="voiceSelect" name="voice" style="background:#23232a;color:#fff;border:1px solid #444;border-radius:4px;padding:4px 8px;font-size:0.95rem;">
          <option value="">Select Voice (default: Jenny)</option>
        </select>
        <button type="submit" style="background:#2563eb;color:#fff;padding:4px 16px;border-radius:4px;font-weight:600;border:none;font-size:0.95rem;">Upload</button>
      </form>
      <div id="status" style="font-size:0.95rem;color:#bbb;margin-left:16px;"></div>
    </div>
    <div class="main-content col-start-2 row-start-1 bg-black text-white pb-0 pr-0 pl-0 flex flex-col h-full transition-all duration-300" id="mainContent" style="margin-top:60px;">
      <div id="searchBarContainer" style="width:100%;max-width:900px;margin:0 auto 0.5em auto;display:flex;align-items:center;gap:0.5em;padding:0.5em 0.5em 0 0.5em;position:relative;z-index:2;">
        <span style="display:inline-flex;align-items:center;justify-content:center;width:2em;height:2em;color:#aaa;font-size:1.2em;">
          <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/></svg>
        </span>
        <input id="searchInput" type="text" placeholder="Search in book..." style="flex:1 1 auto;min-width:0;background:#23232a;color:#fff;border:1px solid #444;border-radius:4px;padding:0.5em 1em;font-size:1em;outline:none;"/>
        <button id="searchPrevBtn" title="Previous match" style="background:#23232a;color:#aaa;border:none;border-radius:4px;padding:0.4em 0.7em;font-size:1em;cursor:pointer;">&#8593;</button>
        <button id="searchNextBtn" title="Next match" style="background:#23232a;color:#aaa;border:none;border-radius:4px;padding:0.4em 0.7em;font-size:1em;cursor:pointer;">&#8595;</button>
        <span id="searchCount" style="color:#aaa;font-size:0.95em;margin-left:0.5em;"></span>
      </div>
      <div id="textDisplay" style="display:block;flex:1 1 auto;overflow-y:auto;min-height:120px;height:auto;max-height:calc(100vh - 60px - 112px);padding:0 1.5rem;"> </div>
    </div>
    <div class="media-controls col-span-2 row-start-2 w-full bg-black border-t border-[#333] p-4 z-[1000] flex flex-col gap-2" id="mediaControls" style="position:sticky; bottom:0; left:0; right:0;">
      <div class="progress-container flex items-center gap-3 mb-2">
        <span class="time-current text-xs text-gray-400" id="audioTimeCurrent">00:00</span>
        <div class="progress-bar flex-1 h-1 bg-[#333] rounded relative cursor-pointer mx-2" id="customProgressBar">
          <div class="progress-fill bg-blue-500 h-1 rounded absolute left-0 top-0" style="width:0%"></div>
          <div class="progress-handle w-4 h-4 bg-blue-500 rounded-full absolute top-1/2 -translate-y-1/2 left-0" style="left:0%"></div>
        </div>
        <span class="time-total text-xs text-gray-400" id="audioTimeTotal">00:00</span>
      </div>
      <div class="control-buttons flex items-center justify-between">
        <div class="media-info flex items-center gap-3">
          <img class="book-cover w-10 h-10 rounded object-cover bg-[#222]" src="" alt="Book cover" id="mediaBookCover"/>
          <div class="book-details flex flex-col">
            <span class="book-title text-sm font-semibold text-white" id="mediaBookTitle">Book Title</span>
            <span class="narrator text-xs text-gray-400" id="mediaNarrator">Read by Narrator</span>
          </div>
        </div>
        <div class="playback-controls flex items-center gap-2">
          <button class="control-btn skip-back" id="rewindBtn" aria-label="Rewind 15 seconds">⏮</button>
          <button class="control-btn play-pause bg-[#333] rounded-full w-12 h-12 flex items-center justify-center text-2xl" id="playBtn" aria-label="Play/Pause">
            <span id="iconPlay">▶️</span>
            <span id="iconPause" class="hidden">⏸️</span>
          </button>
          <button class="control-btn skip-forward" id="forwardBtn" aria-label="Forward 15 seconds">⏭</button>
          <button class="control-btn speed" id="speedSelect" aria-label="Playback speed">1x</button>
        </div>
        <div class="additional-controls flex items-center gap-2">
          <button class="control-btn" id="audioBarSettingsBtn" aria-label="Settings">⚙️</button>
        </div>
      </div>
      <audio id="mainAudio" preload="metadata" style="display:none"></audio>
    </div>
  </div>
  <!-- Dynamic Settings Modal injected by script below -->

  <script>
    // Sidebar mobile toggle logic
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    function openSidebar() {
      sidebar.classList.add('open');
      sidebarOverlay.classList.remove('hidden');
      hamburgerBtn.setAttribute('aria-label', 'Close sidebar');
      document.body.style.overflow = 'hidden';
      // Focus trap
      sidebar.setAttribute('tabindex', '-1');
      sidebar.focus();
    }
    function closeSidebar() {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.add('hidden');
      hamburgerBtn.setAttribute('aria-label', 'Open sidebar');
      document.body.style.overflow = '';
      sidebar.removeAttribute('tabindex');
    }
    hamburgerBtn.addEventListener('click', () => {
      if (sidebar.classList.contains('open')) {
        closeSidebar();
      } else {
        openSidebar();
      }
    });
    sidebarOverlay.addEventListener('click', closeSidebar);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && sidebar.classList.contains('open')) closeSidebar();
    });
    // Trap focus in sidebar when open (mobile)
    sidebar.addEventListener('keydown', function(e) {
      if (!sidebar.classList.contains('open')) return;
      if (e.key === 'Tab') {
        const focusable = sidebar.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (e.shiftKey) {
          if (document.activeElement === first) { e.preventDefault(); last.focus(); }
        } else {
          if (document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      }
    });
    // EPUB logic + audio player
    const chapterList = document.getElementById('chapterList');
    const form        = document.getElementById('uploadForm');
    const textDiv     = document.getElementById('textDisplay');
    const statusDiv   = document.getElementById('status');
    const voiceSelect = document.getElementById('voiceSelect');
    const mainAudio   = document.getElementById('mainAudio');
    const playBtn     = document.getElementById('playBtn');
    const rewindBtn   = document.getElementById('rewindBtn');
    const forwardBtn  = document.getElementById('forwardBtn');
    const speedBtn    = document.getElementById('speedSelect');
    const curTime     = document.getElementById('audioTimeCurrent');
    const totTime     = document.getElementById('audioTimeTotal');
    const progressBar = document.getElementById('customProgressBar');
    const progressFill = progressBar.querySelector('.progress-fill');
    const progressHandle = progressBar.querySelector('.progress-handle');
    const bookCover   = document.getElementById('bookCover');
    const mediaBookTitle = document.getElementById('mediaBookTitle');
    const mediaNarrator = document.getElementById('mediaNarrator');
    let uploadId, chunks = [], cache = {}, currentIdx = 0, playingSeq = false;
    const voices = [
      "en-AU-NatashaNeural","en-AU-WilliamNeural",
      "en-CA-ClaraNeural","en-CA-LiamNeural",
      "en-GB-LibbyNeural","en-GB-RyanNeural","en-GB-SoniaNeural",
      "en-IN-NeerjaNeural","en-IN-PriyaNeural",
      "en-US-AriaNeural","en-US-GuyNeural","en-US-JennyNeural",
      "en-US-MichelleNeural","en-US-TonyNeural"
    ];
    voices.forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      voiceSelect.appendChild(o);
    });
    form.addEventListener('submit', async e => {
      e.preventDefault();
      statusDiv.textContent = 'Extracting text…';
      textDiv.innerHTML = '';
      chapterList.innerHTML = '';
      cache = {};
      const fd = new FormData(form);
      const res = await fetch('/upload', { method:'POST', body: fd });
      if (!res.ok) {
        statusDiv.textContent = `Error: ${await res.text()}`;
        return;
      }
      const data = await res.json();
      uploadId = data.upload_id;
      chunks   = data.text_chunks;
      let chapters = data.chapters || [];
      // Update book title and cover image
      const bookTitle = data.book_title || 'Untitled EPUB';
      document.getElementById('sidebarBookTitle').textContent = bookTitle;
      document.getElementById('mediaBookTitle').textContent = bookTitle;
      if (data.cover_image) {
        document.getElementById('sidebarCover').src = data.cover_image;
        document.getElementById('sidebarCover').style.display = '';
        document.getElementById('mediaBookCover').src = data.cover_image;
        document.getElementById('mediaBookCover').style.display = '';
      } else {
        document.getElementById('sidebarCover').src = '';
        document.getElementById('sidebarCover').style.display = 'none';
        document.getElementById('mediaBookCover').src = '';
        document.getElementById('mediaBookCover').style.display = 'none';
      }
      if (!chapters || chapters.length === 0) {
        chapters = [];
        function looksLikeChapter(text) {
          return /^chapter\s+\d+/i.test(text)
              || /^prologue$/i.test(text)
              || /^epilogue$/i.test(text)
              || /^book\s+\d+/i.test(text)
              || /^part\s+\d+/i.test(text);
        }
        chunks.forEach((c, i) => {
          if (looksLikeChapter(c.trim())) {
            chapters.push({ title: c.trim(), index: i });
          }
        });
        if(chapters.length === 0) {
          for (let i = 0; i < chunks.length; i += Math.floor(chunks.length / 10)) {
            chapters.push({ title: `Chapter ${i + 1}`, index: i });
          }
        }
      }
      chapterList.innerHTML = '';
      chapters.forEach(ch => {
        const li = document.createElement('li');
        li.textContent = ch.title;
        li.dataset.index = ch.index;
        chapterList.appendChild(li);
      });
      textDiv.innerHTML = '';
      chunks.forEach((c, i) => {
        const trimmed = c.trim();
        if (/^chapter\s+\d+/i.test(trimmed) || /^prologue$/i.test(trimmed) || /^epilogue$/i.test(trimmed)) {
          const h = document.createElement('h2');
          h.textContent = trimmed;
          h.dataset.index = i;
          textDiv.appendChild(h);
        } else if (/^data:image\//.test(trimmed) || /\.(jpg|jpeg|png|gif)$/i.test(trimmed)) {
          const img = document.createElement('img');
          img.src = trimmed;
          img.alt = `Image ${i+1}`;
          img.style.maxWidth = '100%';
          img.style.display = 'block';
          img.style.margin = '1.5em auto';
          img.dataset.index = i;
          textDiv.appendChild(img);
        } else {
          const p = document.createElement('p');
          p.textContent = c;
          p.dataset.index = i;
          textDiv.appendChild(p);
        }
      });
      statusDiv.textContent = 'Click a chapter or paragraph to play.';
      // Always show the text area at the top after upload and scroll it into view
      textDiv.scrollTop = 0;
      textDiv.style.display = 'block';
      textDiv.style.minHeight = '120px';
      setTimeout(() => {
        textDiv.scrollIntoView({behavior:'smooth'});
      }, 100);
    });
    chapterList.addEventListener('click', e => {
      if (e.target.tagName !== 'LI') return;
      const idx = Number(e.target.dataset.index);
      const el = textDiv.querySelector(`[data-index="${idx}"]`);
      if (el) {
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        startSequence(idx);
      }
      if (window.innerWidth < 700) closeSidebar();
    });
    textDiv.addEventListener('click', e => {
      if (e.target.tagName !== 'P' && e.target.tagName !== 'H2') return;
      startSequence(+e.target.dataset.index);
    });
    function fetchChunk(i) {
      if (cache[i]) return Promise.resolve(cache[i]);
      return fetch('/chunk', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ upload_id: uploadId, index: i })
      })
      .then(r => r.ok ? r.blob() : Promise.reject(r.statusText))
      .then(blob => {
        const url = URL.createObjectURL(blob);
        cache[i] = url;
        return url;
      });
    }
    function startSequence(idx) {
      playingSeq = true;
      currentIdx = idx;
      mediaNarrator.textContent = (voiceSelect.value ? `Read by ${voiceSelect.value}` : 'Read by Jenny');
      playChunk(idx);
    }
    // Word-level highlighting (best effort)
    let wordTimer = null;
    function playChunk(i) {
      // Remove previous highlights
      textDiv.querySelectorAll('p, h2').forEach(p => {
        p.classList.remove('highlight');
        // Remove word highlight spans if present
        if (p.dataset.wordsplit === '1') {
          p.innerHTML = p.textContent;
          p.dataset.wordsplit = '';
        }
      });
      const el = textDiv.querySelector(`[data-index="${i}"]`);
      if (el) {
        el.classList.add('highlight');
        scrollElementIntoContainer(el, textDiv);
        // Word-level highlight for <p> only
        if (el.tagName === 'P') {
          const words = el.textContent.split(/(\s+)/);
          el.innerHTML = words.map((w, idx) => `<span class="word" data-word-idx="${idx}">${w}</span>`).join('');
          el.dataset.wordsplit = '1';
        }
      }
      // Clear previous word timer
      if (wordTimer) clearInterval(wordTimer);
      fetchChunk(i).then(url => {
        mainAudio.src = url;
        mainAudio.play();
        // Word-level highlight: best effort (split duration by word count)
        if (el && el.tagName === 'P') {
          mainAudio.onloadedmetadata = () => {
            const duration = mainAudio.duration || 1;
            const wordSpans = el.querySelectorAll('.word');
            let idx = 0;
            function highlightWord() {
              wordSpans.forEach((w, j) => w.style.background = j === idx ? 'rgba(76,139,245,0.3)' : '');
            }
            highlightWord();
            if (wordTimer) clearInterval(wordTimer);
            wordTimer = setInterval(() => {
              idx++;
              if (idx >= wordSpans.length) {
                clearInterval(wordTimer);
                return;
              }
              highlightWord();
            }, (duration * 1000) / wordSpans.length);
            mainAudio.onpause = mainAudio.onended = () => { if (wordTimer) clearInterval(wordTimer); };
          };
        }
      });
    }
    mainAudio.onended = () => {
      if (playingSeq && currentIdx + 1 < chunks.length) {
        currentIdx++;
        playChunk(currentIdx);
      } else {
        playingSeq = false;
      }
    };
    mainAudio.onloadedmetadata = () => {
      const d = Math.floor(mainAudio.duration);
      totTime.textContent = `${Math.floor(d/60)}:${String(d%60).padStart(2,'0')}`;
      // prog.max = mainAudio.duration || 100; // This line is no longer needed
    };
    mainAudio.ontimeupdate = () => {
      const t = Math.floor(mainAudio.currentTime);
      curTime.textContent = `${Math.floor(t/60)}:${String(t%60).padStart(2,'0')}`;
      const percent = mainAudio.duration ? (mainAudio.currentTime / mainAudio.duration) * 100 : 0;
      progressFill.style.width = percent + '%';
      progressHandle.style.left = percent + '%';
    };
    progressBar.onclick = function(e) {
      const rect = progressBar.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const percent = Math.max(0, Math.min(1, x / rect.width));
      mainAudio.currentTime = percent * mainAudio.duration;
    };
    // Play/Pause Toggle Button Emojis
    function setPlayPauseIcon(isPlaying) {
      document.getElementById('iconPlay').style.display = isPlaying ? "none" : "";
      document.getElementById('iconPause').style.display = isPlaying ? "" : "none";
    }
    mainAudio.onplay = () => setPlayPauseIcon(true);
    mainAudio.onpause = () => setPlayPauseIcon(false);
    playBtn.onclick = () => {
      if (mainAudio.paused) {
        mainAudio.play();
      } else {
        mainAudio.pause();
      }
    };
    rewindBtn.onclick = () => {
      mainAudio.currentTime = Math.max(0, mainAudio.currentTime - 15);
    };
    forwardBtn.onclick = () => {
      mainAudio.currentTime = Math.min(mainAudio.duration, mainAudio.currentTime + 15);
    };
    speedBtn.addEventListener('click', () => {
      const rates = [1, 1.25, 1.5, 1.75, 2];
      let current = rates.indexOf(mainAudio.playbackRate);
      current = (current + 1) % rates.length;
      mainAudio.playbackRate = rates[current];
      speedBtn.textContent = rates[current] + 'x';
    });
    mainAudio.playbackRate = 1;
    speedBtn.textContent = '1x';
    // Keyboard accessibility for audio bar
    playBtn.onkeydown = rewindBtn.onkeydown = forwardBtn.onkeydown = function(e) {
      if (e.key === " " || e.key === "Enter") { e.preventDefault(); this.click(); }
    };
    document.addEventListener('keydown', function(e) {
      if (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT") return;
      if (e.key === " ") {
        e.preventDefault(); playBtn.click();
      }
      if (e.key === "ArrowLeft") rewindBtn.click();
      if (e.key === "ArrowRight") forwardBtn.click();
    });

    // ===== DYNAMIC SETTINGS PANEL MODAL INJECTION =====
    document.getElementById("audioBarSettingsBtn").onclick = function openSettingsPanel() {
      // Remove any old modal if present
      var old = document.getElementById('settingsOverlayDynamic');
      if (old) old.remove();
      var overlay = document.createElement('div');
      overlay.id = 'settingsOverlayDynamic';
      overlay.className = "fixed inset-0 z-[9999] bg-black/40 flex items-center justify-center";
      overlay.style.backdropFilter = "blur(2px)";
      overlay.innerHTML = `
        <div id="settingsPanelModalDynamic" tabindex="0" class="w-full max-w-md mx-auto rounded-2xl shadow-2xl bg-white/95 backdrop-blur-lg border border-gray-100 p-0 overflow-hidden font-sans relative outline-none" role="dialog" aria-modal="true">
          <button id="settingsPanelCloseBtnDynamic" type="button" class="absolute top-3 right-3 text-gray-500 hover:text-blue-600 text-2xl font-bold" aria-label="Close settings">&times;</button>
          <header class="w-full py-4 px-6 border-b border-gray-100 bg-gray-50 flex items-center justify-between"><h2 class="font-semibold text-lg tracking-wide text-gray-900">Reading Settings</h2></header>
          <main class="p-6 space-y-7">
            <section id="settingsPreview" class="rounded-xl transition-all duration-200 shadow-inner px-6 py-4 border bg-white text-gray-900 font-serif" style="font-size:1.1em;line-height:1.75;letter-spacing:0em;word-spacing:0em;margin:1.5em;text-align:justify;"><div class="mb-1 text-[0.95em] opacity-70 font-medium">Chapter One</div><div>The quick brown fox jumps over the lazy dog. “Reading should be a joy, not a chore,” she thought, as she adjusted her book’s settings.</div></section>
            <div class="space-y-6">
              <!-- Text Size Slider -->
              <div>
                <label for="textSizeSlider" class="block text-sm font-medium text-gray-700 mb-1">Text Size</label>
                <input type="range" id="textSizeSlider" min="0.8" max="2" step="0.01" value="1.1" class="w-full accent-blue-500" aria-label="Text size"/>
                <div class="flex justify-between text-xs mt-1 text-gray-400">
                  <span>Very Small</span><span>Very Large</span>
                </div>
              </div>
              <!-- Theme Selector -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Theme</label>
                <div class="grid grid-cols-2 gap-2 sm:grid-cols-3">
                  <button type="button" class="theme-btn rounded-lg border p-2 flex flex-col items-center gap-1 bg-white text-black font-serif border-gray-300" data-theme="normal" aria-label="Normal"><span class="block w-6 h-6 rounded bg-white border"></span>Normal</button>
                  <button type="button" class="theme-btn rounded-lg border p-2 flex flex-col items-center gap-1 bg-[#f7ecd9] text-[#5a3a1b] font-serif border-gray-300" data-theme="soft" aria-label="Soft"><span class="block w-6 h-6 rounded bg-[#f7ecd9] border"></span>Soft</button>
                  <button type="button" class="theme-btn rounded-lg border p-2 flex flex-col items-center gap-1 bg-white text-black font-serif border-gray-300 font-bold" data-theme="bold" aria-label="Bold"><span class="block w-6 h-6 rounded bg-white border"></span>Bold</button>
                  <button type="button" class="theme-btn rounded-lg border p-2 flex flex-col items-center gap-1 bg-gray-100 text-gray-700 font-serif border-gray-300" data-theme="gray" aria-label="Gray"><span class="block w-6 h-6 rounded bg-gray-100 border"></span>Gray</button>
                  <button type="button" class="theme-btn rounded-lg border p-2 flex flex-col items-center gap-1 bg-black text-gray-200 font-serif border-gray-300" data-theme="quiet" aria-label="Quiet"><span class="block w-6 h-6 rounded bg-black border"></span>Quiet</button>
                  <button type="button" class="theme-btn rounded-lg border p-2 flex flex-col items-center gap-1 bg-[#f5e6d3] text-[#7b5a36] font-serif border-gray-300" data-theme="sepia" aria-label="Sepia"><span class="block w-6 h-6 rounded bg-[#f5e6d3] border"></span>Sepia</button>
                </div>
              </div>
              <!-- Further Customization Button -->
              <div>
                <button id="furtherCustomizationBtn" type="button" class="w-full mt-2 py-2 px-4 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold transition">Further Customization</button>
                <div id="furtherCustomizationPanel" class="hidden mt-4 space-y-4">
                  <div class="flex items-center justify-between">
                    <label for="boldTextToggle" class="text-sm font-medium text-gray-700">Bold Text</label>
                    <input type="checkbox" id="boldTextToggle" class="accent-blue-500"/>
                  </div>
                  <div>
                    <label for="lineSpacingSlider" class="block text-sm font-medium text-gray-700 mb-1">Line Spacing</label>
                    <input type="range" id="lineSpacingSlider" min="1" max="2.5" step="0.01" value="1.75" class="w-full accent-blue-500" aria-label="Line spacing"/>
                  </div>
                  <div>
                    <label for="charSpacingSlider" class="block text-sm font-medium text-gray-700 mb-1">Character Spacing</label>
                    <input type="range" id="charSpacingSlider" min="0" max="0.2" step="0.001" value="0" class="w-full accent-blue-500" aria-label="Character spacing"/>
                  </div>
                  <div>
                    <label for="wordSpacingSlider" class="block text-sm font-medium text-gray-700 mb-1">Word Spacing</label>
                    <input type="range" id="wordSpacingSlider" min="0" max="1" step="0.01" value="0" class="w-full accent-blue-500" aria-label="Word spacing"/>
                  </div>
                  <div>
                    <label for="marginSizeSlider" class="block text-sm font-medium text-gray-700 mb-1">Margin Size</label>
                    <input type="range" id="marginSizeSlider" min="0.5" max="4" step="0.01" value="1.5" class="w-full accent-blue-500" aria-label="Margin size"/>
                  </div>
                  <div class="flex items-center justify-between">
                    <label for="justifyTextToggle" class="text-sm font-medium text-gray-700">Justify Text</label>
                    <input type="checkbox" id="justifyTextToggle" class="accent-blue-500" checked/>
                  </div>
                </div>
              </div>
            </div>
            <div class="my-2 text-xs text-gray-500">Close with ×, Escape, or click outside.</div>
          </main>
        </div>
      `;
      document.body.appendChild(overlay);
      document.body.style.overflow = "hidden";
      function closePanel() {
        overlay.remove();
        document.body.style.overflow = "";
        document.removeEventListener("keydown", keydownHandler);
      }
      overlay.querySelector('#settingsPanelCloseBtnDynamic').onclick = closePanel;
      overlay.onclick = (e) => { if (e.target === overlay) closePanel(); };
      function keydownHandler(e) { if (e.key === "Escape") closePanel(); }
      document.addEventListener("keydown", keydownHandler);
      setTimeout(()=>{ var modal = overlay.querySelector('#settingsPanelModalDynamic'); if (modal) modal.focus(); }, 25);
      // --- Settings Panel Interactivity ---
      const preview = overlay.querySelector('#settingsPreview');
      const textDisplay = document.getElementById('textDisplay');
      // Helper to apply a style to both preview and textDisplay
      function applyStyle(prop, value) {
        preview.style[prop] = value;
        textDisplay.style[prop] = value;
      }
      // Text Size
      overlay.querySelector('#textSizeSlider').oninput = function(e) {
        applyStyle('fontSize', e.target.value + 'em');
      };
      // Theme Selector
      overlay.querySelectorAll('.theme-btn').forEach(btn => {
        btn.onclick = function() {
          overlay.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('ring-2','ring-blue-500'));
          btn.classList.add('ring-2','ring-blue-500');
          const theme = btn.getAttribute('data-theme');
          // Theme styles
          const themes = {
            normal:  { bg:'#fff', color:'#222', font:'serif', fontWeight:'normal' },
            soft:    { bg:'#f7ecd9', color:'#5a3a1b', font:'serif', fontWeight:'normal' },
            bold:    { bg:'#fff', color:'#000', font:'serif', fontWeight:'bold' },
            gray:    { bg:'#f3f4f6', color:'#6b7280', font:'serif', fontWeight:'normal' },
            quiet:   { bg:'#000', color:'#e5e7eb', font:'serif', fontWeight:'normal' },
            sepia:   { bg:'#f5e6d3', color:'#7b5a36', font:'serif', fontWeight:'normal' },
          };
          const t = themes[theme];
          preview.style.background = t.bg;
          preview.style.color = t.color;
          preview.style.fontFamily = t.font === 'serif' ? 'Georgia, Times New Roman, serif' : 'Inter, Arial, sans-serif';
          preview.style.fontWeight = t.fontWeight;
          textDisplay.style.background = t.bg;
          textDisplay.style.color = t.color;
          textDisplay.style.fontFamily = t.font === 'serif' ? 'Georgia, Times New Roman, serif' : 'Inter, Arial, sans-serif';
          textDisplay.style.fontWeight = t.fontWeight;
        };
      });
      // Further Customization
      const furtherBtn = overlay.querySelector('#furtherCustomizationBtn');
      const furtherPanel = overlay.querySelector('#furtherCustomizationPanel');
      furtherBtn.onclick = function() {
        furtherPanel.classList.toggle('hidden');
        furtherBtn.classList.toggle('bg-blue-200');
      };
      // Bold Text
      overlay.querySelector('#boldTextToggle').oninput = function(e) {
        applyStyle('fontWeight', e.target.checked ? 'bold' : '');
      };
      // Line Spacing
      overlay.querySelector('#lineSpacingSlider').oninput = function(e) {
        applyStyle('lineHeight', e.target.value);
      };
      // Character Spacing
      overlay.querySelector('#charSpacingSlider').oninput = function(e) {
        applyStyle('letterSpacing', e.target.value + 'em');
      };
      // Word Spacing
      overlay.querySelector('#wordSpacingSlider').oninput = function(e) {
        applyStyle('wordSpacing', e.target.value + 'em');
      };
      // Margin Size
      overlay.querySelector('#marginSizeSlider').oninput = function(e) {
        applyStyle('margin', e.target.value + 'em');
      };
      // Justify Text
      overlay.querySelector('#justifyTextToggle').oninput = function(e) {
        applyStyle('textAlign', e.target.checked ? 'justify' : 'left');
      };
    };

    // SEARCH LOGIC
    let searchMatches = [];
    let currentMatchIdx = -1;
    const searchInput = document.getElementById('searchInput');
    const searchPrevBtn = document.getElementById('searchPrevBtn');
    const searchNextBtn = document.getElementById('searchNextBtn');
    const searchCount = document.getElementById('searchCount');
    function clearSearchHighlights() {
      document.querySelectorAll('#textDisplay .search-highlight').forEach(el => {
        const parent = el.parentNode;
        parent.replaceChild(document.createTextNode(el.textContent), el);
        parent.normalize();
      });
      searchMatches = [];
      currentMatchIdx = -1;
      searchCount.textContent = '';
    }
    function highlightSearch(term) {
      clearSearchHighlights();
      if (!term || term.length < 2) return;
      const regex = new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      const walker = document.createTreeWalker(document.getElementById('textDisplay'), NodeFilter.SHOW_TEXT, null);
      let node;
      while ((node = walker.nextNode())) {
        if (node.parentNode && node.parentNode.closest('.search-highlight')) continue;
        let match;
        let lastIndex = 0;
        const text = node.textContent;
        let newNodes = [];
        while ((match = regex.exec(text))) {
          if (match.index > lastIndex) {
            newNodes.push(document.createTextNode(text.slice(lastIndex, match.index)));
          }
          const span = document.createElement('span');
          span.className = 'search-highlight';
          span.textContent = match[0];
          span.style.background = 'rgba(255, 230, 0, 0.5)';
          span.style.color = '#222';
          newNodes.push(span);
          searchMatches.push(span);
          lastIndex = match.index + match[0].length;
        }
        if (lastIndex < text.length) {
          newNodes.push(document.createTextNode(text.slice(lastIndex)));
        }
        if (newNodes.length) {
          newNodes.forEach(n => node.parentNode.insertBefore(n, node));
          node.parentNode.removeChild(node);
        }
      }
      if (searchMatches.length) {
        currentMatchIdx = 0;
        updateSearchHighlight();
      }
      searchCount.textContent = searchMatches.length ? `${currentMatchIdx+1}/${searchMatches.length}` : '0/0';
    }
    function updateSearchHighlight() {
      searchMatches.forEach((el, i) => {
        el.style.outline = i === currentMatchIdx ? '2px solid #2563eb' : '';
        el.scrollIntoView({behavior:'smooth', block:'center'});
      });
      searchCount.textContent = searchMatches.length ? `${currentMatchIdx+1}/${searchMatches.length}` : '0/0';
    }
    searchInput.addEventListener('input', e => {
      highlightSearch(e.target.value);
    });
    searchPrevBtn.addEventListener('click', () => {
      if (!searchMatches.length) return;
      currentMatchIdx = (currentMatchIdx - 1 + searchMatches.length) % searchMatches.length;
      updateSearchHighlight();
    });
    searchNextBtn.addEventListener('click', () => {
      if (!searchMatches.length) return;
      currentMatchIdx = (currentMatchIdx + 1) % searchMatches.length;
      updateSearchHighlight();
    });
    // Helper: scroll an element into a container (not the whole page)
    function scrollElementIntoContainer(element, container) {
      if (!element || !container) return;
      const elRect = element.getBoundingClientRect();
      const contRect = container.getBoundingClientRect();
      if (elRect.top < contRect.top) {
        container.scrollTop -= (contRect.top - elRect.top) + 16;
      } else if (elRect.bottom > contRect.bottom) {
        container.scrollTop += (elRect.bottom - contRect.bottom) + 16;
      }
    }
  </script>
</body>
</html>
